<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>D:\Programming\Projects\LlmUnitTestGenerationArtifacts\Glm45AirUnitTests\Sample3Tests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Linq.Expressions;
using Dataset.Sample3;
using NSubstitute;

namespace Glm45AirUnitTests;

public class NoteServiceTests
{
    private readonly IUnitOfWork _unitOfWorkMock;
    private readonly IRepository&lt;NoteEntity&gt; _repositoryMock;
    private readonly NoteService _noteService;

    public NoteServiceTests()
    {
        _unitOfWorkMock = Substitute.For&lt;IUnitOfWork&gt;();
        _repositoryMock = Substitute.For&lt;IRepository&lt;NoteEntity&gt;&gt;();
        _unitOfWorkMock.GetRepository&lt;NoteEntity&gt;().Returns(_repositoryMock);
        _noteService = new NoteService(_unitOfWorkMock);
    }

    public class GetAllByUserIdAsync : NoteServiceTests
    {
        [Fact]
        public async Task GivenValidUserId_WhenCalled_ReturnsNoteModels()
        {
            // Arrange
            int userId = 1;
            var noteEntities = new List&lt;NoteEntity&gt;
            {
                new NoteEntity { Id = 1, Title = &quot;Test1&quot;, Content = &quot;Content1&quot;, UserId = userId },
                new NoteEntity { Id = 2, Title = &quot;Test2&quot;, Content = &quot;Content2&quot;, UserId = userId }
            };
            _repositoryMock.GetAllAsync(Arg.Any&lt;Expression&lt;Func&lt;NoteEntity, bool&gt;&gt;&gt;())
                .Returns(noteEntities);

            // Act
            var result = await _noteService.GetAllByUserIdAsync(userId);

            // Assert
            Assert.NotNull(result);
            Assert.Equal(2, result.Count);
            Assert.Equal(noteEntities[0].Id, result.ElementAt(0).Id);
            Assert.Equal(noteEntities[0].Title, result.ElementAt(0).Title);
            Assert.Equal(noteEntities[0].Content, result.ElementAt(0).Content);
            Assert.Equal(noteEntities[0].UserId, result.ElementAt(0).UserId);
            Assert.Equal(noteEntities[1].Id, result.ElementAt(1).Id);
            Assert.Equal(noteEntities[1].Title, result.ElementAt(1).Title);
            Assert.Equal(noteEntities[1].Content, result.ElementAt(1).Content);
            Assert.Equal(noteEntities[1].UserId, result.ElementAt(1).UserId);
            await _repositoryMock.Received(1).GetAllAsync(Arg.Is&lt;Expression&lt;Func&lt;NoteEntity, bool&gt;&gt;&gt;(e =&gt; e.Compile().Invoke(new NoteEntity { UserId = userId })));
        }

        [Fact]
        public async Task GivenNoNotesForUserId_WhenCalled_ReturnsEmptyCollection()
        {
            // Arrange
            int userId = 1;
            _repositoryMock.GetAllAsync(Arg.Any&lt;Expression&lt;Func&lt;NoteEntity, bool&gt;&gt;&gt;())
                .Returns(new List&lt;NoteEntity&gt;());

            // Act
            var result = await _noteService.GetAllByUserIdAsync(userId);

            // Assert
            Assert.NotNull(result);
            Assert.Empty(result);
            await _repositoryMock.Received(1).GetAllAsync(Arg.Any&lt;Expression&lt;Func&lt;NoteEntity, bool&gt;&gt;&gt;());
        }
    }

    public class GetByIdAsync : NoteServiceTests
    {
        [Fact]
        public async Task GivenExistingId_WhenCalled_ReturnsNoteModel()
        {
            // Arrange
            int id = 1;
            var noteEntity = new NoteEntity { Id = id, Title = &quot;Test&quot;, Content = &quot;Content&quot;, UserId = 1 };
            _repositoryMock.GetByIdAsync(id).Returns(noteEntity);

            // Act
            var result = await _noteService.GetByIdAsync(id);

            // Assert
            Assert.NotNull(result);
            Assert.Equal(id, result.Id);
            Assert.Equal(noteEntity.Title, result.Title);
            Assert.Equal(noteEntity.Content, result.Content);
            Assert.Equal(noteEntity.UserId, result.UserId);
            await _repositoryMock.Received(1).GetByIdAsync(id);
        }

        [Fact]
        public async Task GivenNonExistingId_WhenCalled_ThrowsNoteNotFoundException()
        {
            // Arrange
            int id = 1;
            _repositoryMock.GetByIdAsync(id).Returns((NoteEntity?)null);

            // Act &amp; Assert
            await Assert.ThrowsAsync&lt;NoteNotFoundException&gt;(async () =&gt; await _noteService.GetByIdAsync(id));
            await _repositoryMock.Received(1).GetByIdAsync(id);
        }
    }

    public class AddAsync : NoteServiceTests
    {
        [Fact]
        public async Task GivenValidNoteModel_WhenCalled_ReturnsNewId()
        {
            // Arrange
            var noteModel = new NoteModel { Title = &quot;Test&quot;, Content = &quot;Content&quot;, UserId = 1 };
            var noteEntity = new NoteEntity { Id = 1, Title = &quot;Test&quot;, Content = &quot;Content&quot;, UserId = 1 };
            var addedNoteEntity = new NoteEntity { Id = 2, Title = &quot;Test&quot;, Content = &quot;Content&quot;, UserId = 1 };
            _repositoryMock.AddAsync(noteEntity).Returns(addedNoteEntity);
            var transactionMock = Substitute.For&lt;IDbContextTransaction&gt;();
            _unitOfWorkMock.BeginTransactionAsync().Returns(Task.FromResult(transactionMock));
            _unitOfWorkMock.SaveAsync().Returns(Task.CompletedTask);

            // Act
            var result = await _noteService.AddAsync(noteModel);

            // Assert
            Assert.Equal(addedNoteEntity.Id, result);
            await _unitOfWorkMock.Received(1).BeginTransactionAsync();
            await _unitOfWorkMock.Received(1).SaveAsync();
            await transactionMock.Received(1).CommitAsync();
            Assert.Equal(0, noteModel.Id);
            Assert.Equal(DateTime.UtcNow.Date, noteModel.CreatedAt.Date);
            Assert.Equal(DateTime.UtcNow.Date, noteModel.ModifiedAt.Date);
            Assert.Equal(&quot;Test&quot;, noteModel.Title);
        }

        [Theory]
        [InlineData(null)]
        [InlineData(&quot;&quot;)]
        public async Task GivenNoteModelWithNullContent_WhenCalled_ThrowsNoteNotFoundException(string content)
        {
            // Arrange
            var noteModel = new NoteModel { Title = &quot;Test&quot;, Content = content, UserId = 1 };

            // Act &amp; Assert
            await Assert.ThrowsAsync&lt;NoteNotFoundException&gt;(async () =&gt; await _noteService.AddAsync(noteModel));
            await _unitOfWorkMock.DidNotReceive().BeginTransactionAsync();
            await _unitOfWorkMock.DidNotReceive().SaveAsync();
        }

        [Fact]
        public async Task GivenNoteModelWithInvalidUserId_WhenCalled_ThrowsUserNotFoundException()
        {
            // Arrange
            var noteModel = new NoteModel { Title = &quot;Test&quot;, Content = &quot;Content&quot;, UserId = -1 };

            // Act &amp; Assert
            await Assert.ThrowsAsync&lt;UserNotFoundException&gt;(async () =&gt; await _noteService.AddAsync(noteModel));
            await _unitOfWorkMock.DidNotReceive().BeginTransactionAsync();
            await _unitOfWorkMock.DidNotReceive().SaveAsync();
        }

        [Fact]
        public async Task WhenSaveFails_RollsBackTransaction()
        {
            // Arrange
            var noteModel = new NoteModel { Title = &quot;Test&quot;, Content = &quot;Content&quot;, UserId = 1 };
            var noteEntity = new NoteModel { Id = 0, Title = &quot;Test&quot;, Content = &quot;Content&quot;, UserId = 1 };
            var transactionMock = Substitute.For&lt;IDbContextTransaction&gt;();
            _unitOfWorkMock.BeginTransactionAsync().Returns(Task.FromResult(transactionMock));
            _unitOfWorkMock.When(u =&gt; u.SaveAsync()).Do(_ =&gt; throw new Exception(&quot;Save failed&quot;));

            // Act &amp; Assert
            await Assert.ThrowsAsync&lt;Exception&gt;(async () =&gt; await _noteService.AddAsync(noteModel));
            await transactionMock.Received(1).RollbackAsync();
            await transactionMock.DidNotReceive().CommitAsync();
        }
    }

    public class UpdateAsync : NoteServiceTests
    {
        [Fact]
        public async Task GivenValidNoteModel_WhenCalled_ReturnsUpdatedId()
        {
            // Arrange
            int id = 1;
            var noteModel = new NoteModel { Id = id, Title = &quot;Test&quot;, Content = &quot;Content&quot;, UserId = 1, CreatedAt = new DateTime(2023, 1, 1) };
            var oldNoteEntity = new NoteEntity { Id = id, Title = &quot;Old&quot;, Content = &quot;OldContent&quot;, UserId = 1, CreatedAt = new DateTime(2023, 1, 1) };
            var newNoteEntity = new NoteEntity { Id = id, Title = &quot;Test&quot;, Content = &quot;Content&quot;, UserId = 1, CreatedAt = new DateTime(2023, 1, 1), ModifiedAt = DateTime.UtcNow };
            var updatedNoteEntity = new NoteEntity { Id = id, Title = &quot;Test&quot;, Content = &quot;Content&quot;, UserId = 1, CreatedAt = new DateTime(2023, 1, 1), ModifiedAt = DateTime.UtcNow };
            _repositoryMock.FirstOrDefaultAsNoTrackingAsync(Arg.Any&lt;Expression&lt;Func&lt;NoteEntity, bool&gt;&gt;&gt;()).Returns(oldNoteEntity);
            _repositoryMock.Update(newNoteEntity).Returns(updatedNoteEntity);
            var transactionMock = Substitute.For&lt;IDbContextTransaction&gt;();
            _unitOfWorkMock.BeginTransactionAsync().Returns(Task.FromResult(transactionMock));
            _unitOfWorkMock.SaveAsync().Returns(Task.CompletedTask);

            // Act
            var result = await _noteService.UpdateAsync(noteModel);

            // Assert
            Assert.Equal(id, result);
            Assert.Equal(oldNoteEntity.CreatedAt, noteModel.CreatedAt);
            Assert.Equal(DateTime.UtcNow.Date, noteModel.ModifiedAt.Date);
            Assert.Equal(&quot;Test&quot;, noteModel.Title);
            await _unitOfWorkMock.Received(1).BeginTransactionAsync();
            await _unitOfWorkMock.Received(1).SaveAsync();
            await transactionMock.Received(1).CommitAsync();
        }

        [Theory]
        [InlineData(null)]
        [InlineData(&quot;&quot;)]
        public async Task GivenNoteModelWithNullContent_WhenCalled_ThrowsNoteNotFoundException(string content)
        {
            // Arrange
            var noteModel = new NoteModel { Id = 1, Title = &quot;Test&quot;, Content = content, UserId = 1 };

            // Act &amp; Assert
            await Assert.ThrowsAsync&lt;NoteNotFoundException&gt;(async () =&gt; await _noteService.UpdateAsync(noteModel));
            await _unitOfWorkMock.DidNotReceive().BeginTransactionAsync();
            await _unitOfWorkMock.DidNotReceive().SaveAsync();
        }

        [Fact]
        public async Task GivenNonExistingNoteId_WhenCalled_ThrowsNoteNotFoundException()
        {
            // Arrange
            var noteModel = new NoteModel { Id = 1, Title = &quot;Test&quot;, Content = &quot;Content&quot;, UserId = 1 };
            _repositoryMock.FirstOrDefaultAsNoTrackingAsync(Arg.Any&lt;Expression&lt;Func&lt;NoteEntity, bool&gt;&gt;&gt;()).Returns((NoteEntity?)null);

            // Act &amp; Assert
            await Assert.ThrowsAsync&lt;NoteNotFoundException&gt;(async () =&gt; await _noteService.UpdateAsync(noteModel));
            await _unitOfWorkMock.DidNotReceive().BeginTransactionAsync();
            await _unitOfWorkMock.DidNotReceive().SaveAsync();
        }

        [Fact]
        public async Task GivenUserIdMismatch_WhenCalled_ThrowsUserNotFoundException()
        {
            // Arrange
            int id = 1;
            var noteModel = new NoteModel { Id = id, Title = &quot;Test&quot;, Content = &quot;Content&quot;, UserId = 2 };
            var oldNoteEntity = new NoteEntity { Id = id, Title = &quot;Old&quot;, Content = &quot;OldContent&quot;, UserId = 1 };
            _repositoryMock.FirstOrDefaultAsNoTrackingAsync(Arg.Any&lt;Expression&lt;Func&lt;NoteEntity, bool&gt;&gt;&gt;()).Returns(oldNoteEntity);

            // Act &amp; Assert
            await Assert.ThrowsAsync&lt;UserNotFoundException&gt;(async () =&gt; await _noteService.UpdateAsync(noteModel));
            await _unitOfWorkMock.DidNotReceive().BeginTransactionAsync();
            await _unitOfWorkMock.DidNotReceive().SaveAsync();
        }

        [Fact]
        public async Task WhenSaveFails_RollsBackTransaction()
        {
            // Arrange
            int id = 1;
            var noteModel = new NoteModel { Id = id, Title = &quot;Test&quot;, Content = &quot;Content&quot;, UserId = 1, CreatedAt = new DateTime(2023, 1, 1) };
            var oldNoteEntity = new NoteEntity { Id = id, Title = &quot;Old&quot;, Content = &quot;OldContent&quot;, UserId = 1, CreatedAt = new DateTime(2023, 1, 1) };
            _repositoryMock.FirstOrDefaultAsNoTrackingAsync(Arg.Any&lt;Expression&lt;Func&lt;NoteEntity, bool&gt;&gt;&gt;()).Returns(oldNoteEntity);
            var transactionMock = Substitute.For&lt;IDbContextTransaction&gt;();
            _unitOfWorkMock.BeginTransactionAsync().Returns(Task.FromResult(transactionMock));
            _unitOfWorkMock.When(u =&gt; u.SaveAsync()).Do(_ =&gt; throw new Exception(&quot;Save failed&quot;));

            // Act &amp; Assert
            await Assert.ThrowsAsync&lt;Exception&gt;(async () =&gt; await _noteService.UpdateAsync(noteModel));
            await transactionMock.Received(1).RollbackAsync();
            await transactionMock.DidNotReceive().CommitAsync();
        }
    }

    public class DeleteByIdAsync : NoteServiceTests
    {
        [Fact]
        public async Task GivenExistingId_WhenCalled_ReturnsDeletedId()
        {
            // Arrange
            int id = 1;
            var noteEntity = new NoteEntity { Id = id, Title = &quot;Test&quot;, Content = &quot;Content&quot;, UserId = 1 };
            var deletedNoteEntity = new NoteEntity { Id = id, Title = &quot;Test&quot;, Content = &quot;Content&quot;, UserId = 1 };
            _repositoryMock.GetByIdAsync(id).Returns(noteEntity);
            _repositoryMock.Delete(noteEntity).Returns(deletedNoteEntity);
            var transactionMock = Substitute.For&lt;IDbContextTransaction&gt;();
            _unitOfWorkMock.BeginTransactionAsync().Returns(Task.FromResult(transactionMock));
            _unitOfWorkMock.SaveAsync().Returns(Task.CompletedTask);

            // Act
            var result = await _noteService.DeleteByIdAsync(id);

            // Assert
            Assert.Equal(id, result);
            await _unitOfWorkMock.Received(1).BeginTransactionAsync();
            await _unitOfWorkMock.Received(1).SaveAsync();
            await transactionMock.Received(1).CommitAsync();
        }

        [Fact]
        public async Task GivenNonExistingId_WhenCalled_ThrowsNoteNotFoundException()
        {
            // Arrange
            int id = 1;
            _repositoryMock.GetByIdAsync(id).Returns((NoteEntity?)null);

            // Act &amp; Assert
            await Assert.ThrowsAsync&lt;NoteNotFoundException&gt;(async () =&gt; await _noteService.DeleteByIdAsync(id));
            await _unitOfWorkMock.DidNotReceive().BeginTransactionAsync();
            await _unitOfWorkMock.DidNotReceive().SaveAsync();
        }

        [Fact]
        public async Task WhenSaveFails_RollsBackTransaction()
        {
            // Arrange
            int id = 1;
            var noteEntity = new NoteEntity { Id = id, Title = &quot;Test&quot;, Content = &quot;Content&quot;, UserId = 1 };
            _repositoryMock.GetByIdAsync(id).Returns(noteEntity);
            var transactionMock = Substitute.For&lt;IDbContextTransaction&gt;();
            _unitOfWorkMock.BeginTransactionAsync().Returns(Task.FromResult(transactionMock));
            _unitOfWorkMock.When(u =&gt; u.SaveAsync()).Do(_ =&gt; throw new Exception(&quot;Save failed&quot;));

            // Act &amp; Assert
            await Assert.ThrowsAsync&lt;Exception&gt;(async () =&gt; await _noteService.DeleteByIdAsync(id));
            await transactionMock.Received(1).RollbackAsync();
            await transactionMock.DidNotReceive().CommitAsync();
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[13,5,13,30,1],[14,5,14,6,1],[15,9,15,57,1],[16,9,16,69,1],[17,9,17,78,1],[18,9,18,57,1],[19,5,19,6,1],[25,9,25,10,1],[27,13,27,28,1],[28,13,32,15,1],[33,13,34,40,1],[37,13,37,73,1],[40,13,40,36,1],[41,13,41,43,1],[42,13,42,70,1],[43,13,43,76,1],[44,13,44,80,1],[45,13,45,78,1],[46,13,46,70,1],[47,13,47,76,1],[48,13,48,80,1],[49,13,49,78,1],[50,13,50,164,1],[51,9,51,10,1],[55,9,55,10,1],[57,13,57,28,1],[58,13,59,50,1],[62,13,62,73,1],[65,13,65,36,1],[66,13,66,34,1],[67,13,67,106,1],[68,9,68,10,1],[75,9,75,10,1],[77,13,77,24,1],[78,13,78,106,1],[79,13,79,66,1],[82,13,82,62,1],[85,13,85,36,1],[86,13,86,41,1],[87,13,87,58,1],[88,13,88,62,1],[89,13,89,60,1],[90,13,90,64,1],[91,9,91,10,1],[95,9,95,10,1],[97,13,97,24,1],[98,13,98,73,1],[101,13,101,73,1],[101,73,101,108,1],[101,108,101,110,1],[102,13,102,64,1],[103,9,103,10,1],[110,9,110,10,1],[112,13,112,95,1],[113,13,113,105,1],[114,13,114,110,1],[115,13,115,75,1],[116,13,116,75,1],[117,13,117,95,1],[118,13,118,69,1],[121,13,121,65,1],[124,13,124,54,0],[125,13,125,71,0],[126,13,126,59,0],[127,13,127,61,0],[128,13,128,43,0],[129,13,129,74,0],[130,13,130,75,0],[131,13,131,51,0],[132,9,132,10,0],[138,9,138,10,1],[140,13,140,93,1],[143,13,143,73,1],[143,73,143,111,1],[143,111,143,113,1],[144,13,144,75,1],[145,13,145,63,1],[146,9,146,10,1],[150,9,150,10,1],[152,13,152,96,1],[155,13,155,73,1],[155,73,155,111,1],[155,111,155,113,1],[156,13,156,75,1],[157,13,157,63,1],[158,9,158,10,1],[162,9,162,10,1],[164,13,164,95,1],[165,13,165,104,1],[166,13,166,75,1],[167,13,167,95,1],[168,13,168,39,1],[168,39,168,52,1],[168,52,168,62,1],[168,62,168,96,1],[168,96,168,98,1],[171,13,171,61,1],[171,61,171,99,1],[171,99,171,101,1],[172,13,172,63,1],[173,13,173,65,1],[174,9,174,10,1],[181,9,181,10,1],[183,13,183,24,1],[184,13,184,142,1],[185,13,185,149,1],[186,13,186,177,1],[187,13,187,181,1],[188,13,188,131,1],[189,13,189,78,1],[190,13,190,75,1],[191,13,191,95,1],[192,13,192,69,1],[195,13,195,68,1],[198,13,198,38,0],[199,13,199,72,0],[200,13,200,75,0],[201,13,201,51,0],[202,13,202,71,0],[203,13,203,59,0],[204,13,204,61,0],[205,9,205,10,0],[211,9,211,10,1],[213,13,213,101,1],[216,13,216,73,1],[216,73,216,114,1],[216,114,216,116,1],[217,13,217,75,1],[218,13,218,63,1],[219,9,219,10,1],[223,9,223,10,1],[225,13,225,103,1],[226,13,226,135,1],[229,13,229,73,1],[229,73,229,114,1],[229,114,229,116,1],[230,13,230,75,1],[231,13,231,63,1],[232,9,232,10,1],[236,9,236,10,1],[238,13,238,24,1],[239,13,239,104,1],[240,13,240,111,1],[241,13,241,131,1],[244,13,244,73,1],[244,73,244,114,1],[244,114,244,116,1],[245,13,245,75,1],[246,13,246,63,1],[247,9,247,10,1],[251,9,251,10,1],[253,13,253,24,1],[254,13,254,142,1],[255,13,255,149,1],[256,13,256,131,1],[257,13,257,75,1],[258,13,258,95,1],[259,13,259,39,1],[259,39,259,52,1],[259,52,259,62,1],[259,62,259,96,1],[259,96,259,98,1],[262,13,262,61,1],[262,61,262,102,1],[262,102,262,104,1],[263,13,263,63,1],[264,13,264,65,1],[265,9,265,10,1],[272,9,272,10,1],[274,13,274,24,1],[275,13,275,106,1],[276,13,276,113,1],[277,13,277,66,1],[278,13,278,75,1],[279,13,279,75,1],[280,13,280,95,1],[281,13,281,69,1],[284,13,284,65,1],[287,13,287,38,1],[288,13,288,71,1],[289,13,289,59,1],[290,13,290,61,1],[291,9,291,10,1],[295,9,295,10,1],[297,13,297,24,1],[298,13,298,73,1],[301,13,301,73,1],[301,73,301,111,1],[301,111,301,113,1],[302,13,302,75,1],[303,13,303,63,1],[304,9,304,10,1],[308,9,308,10,1],[310,13,310,24,1],[311,13,311,106,1],[312,13,312,66,1],[313,13,313,75,1],[314,13,314,95,1],[315,13,315,39,1],[315,39,315,52,1],[315,52,315,62,1],[315,62,315,96,1],[315,96,315,98,1],[318,13,318,61,1],[318,61,318,99,1],[318,99,318,101,1],[319,13,319,63,1],[320,13,320,65,1],[321,9,321,10,1]]);
    </script>
  </body>
</html>